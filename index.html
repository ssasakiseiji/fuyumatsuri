<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Stands del Evento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { height: 100%; }
        body {
            font-family: 'Inter', sans-serif;
            color: #E5E7EB;
            margin: 0;
            background-color: #0f172a; 
        }
        #app-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
            padding: 1rem; 
            box-sizing: border-box; 
            min-height: 100vh;
            position: relative;
            z-index: 20;
        }
        #admin-controls {
            position: fixed; top: 1rem; left: 1rem;
            background-color: rgba(17, 24, 39, 0.8); backdrop-filter: blur(10px);
            padding: 0.75rem; border-radius: 0.75rem; border: 1px solid rgba(55, 65, 81, 0.5);
            z-index: 100; display: none;
        }
        .logo-container { width: 100%; max-width: 450px; padding: 1rem 0; display: flex; justify-content: center; }
        #main-logo-container img { max-width: 90%; height: auto; opacity: 1; }
        .logo-container img { max-width: 60%; height: auto; }
        #map-card {
            background-image: url('./sources/mapa.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            position: relative; aspect-ratio: 700 / 1245;
            width: 100%; max-width: 450px;
        }
        #map-card.position-edit-mode { border: 2px dashed rgba(75, 85, 99, 0.5); }
        #map-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .stand {
            position: absolute; display: flex; justify-content: center; align-items: center;
            color: white; font-weight: bold;
            font-size: 0.9vw;
            border-radius: 6px; transition: all 0.2s ease-in-out;
            border: 1px solid rgba(255, 255, 255, 0.3); z-index: 10;
            transform-origin: center center;
            opacity: 1;
        }
        .available { background-color: rgb(34, 197, 94); }
        .occupied { background-color: rgb(107, 114, 128); }
        .stand.position-edit-mode {
            cursor: move; border: 2px dashed #f59e0b;
            z-index: 50; opacity: 0.7;
        }
        .hidden-visible {
            background-color: rgba(139, 92, 246, 0.5);
            border: 2px dashed #a78bfa;
        }
        .stand-tooltip {
            position: absolute; bottom: 110%; left: 50%;
            transform: translateX(-50%); background-color: #1F2937;
            color: white; padding: 0.4rem 0.8rem; border-radius: 0.5rem;
            font-size: 1rem; font-weight: 600; white-space: nowrap;
            opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none; z-index: 60;
        }
        .stand:hover .stand-tooltip, .stand.show-tooltip .stand-tooltip {
            opacity: 1; visibility: visible;
        }
        .handle { position: absolute; width: 18px; height: 18px; border-radius: 50%; display: none; z-index: 51; }
        .stand.position-edit-mode .handle { display: block; }
        .resize-handle { background-color: #f59e0b; border: 2px solid white; right: -10px; bottom: -10px; cursor: se-resize; }
        .rotate-handle { background-color: #10b981; border: 2px solid white; top: -10px; left: 50%; transform: translateX(-50%); cursor: grab; }
        .modal-backdrop { transition: opacity 0.3s ease; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); }
        #lightbox:not(.hidden) { display: flex; justify-content: center; align-items: center; }
        #lightbox img { max-height: 80vh; max-width: 80vw; }
        .lightbox-nav { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(0,0,0,0.5); color: white; border: none; font-size: 2rem; padding: 0.5rem 1rem; cursor: pointer; border-radius: 50%; }
        #lightbox-prev { left: 1rem; }
        #lightbox-next { right: 1rem; }
        #lightbox-close { position: absolute; top: 1rem; right: 1rem; color: white; font-size: 2rem; cursor: pointer; background: none; border: none; }
        .gallery-grid { display: grid; gap: 0.5rem; width: 100%; aspect-ratio: 16 / 9; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 0.5rem; cursor: pointer; transition: transform 0.2s ease-in-out; }
        .gallery-item img:hover { transform: scale(1.05); }
        .gallery-count-1 { grid-template-columns: 1fr; }
        .gallery-count-2 { grid-template-columns: repeat(2, 1fr); }
        .gallery-count-3 { grid-template-columns: 2fr 1fr; grid-template-rows: repeat(2, 1fr); }
        .gallery-count-3 .gallery-item:first-child { grid-row: span 2; }
        .delete-img-btn { position: absolute; top: -5px; right: -5px; background-color: red; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: 1px solid white; cursor: pointer; }
        .modal-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background-color: rgba(255,255,255,0.1); border-radius: 50%;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; transition: background-color 0.2s;
            z-index: 150;
        }
        .modal-nav:hover { background-color: rgba(255,255,255,0.2); }
        #modal-prev { left: -50px; }
        #modal-next { right: -50px; }

        .event-info-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: rgba(17, 24, 39, 0.5);
            border-radius: 1rem;
            width: 100%;
            max-width: 450px;
            border: 1px solid rgba(55, 65, 81, 0.5);
        }
        .info-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.125rem;
            color: #D1D5DB;
        }
        .info-item a {
            text-decoration: none;
            color: #93C5FD;
            transition: color 0.2s ease-in-out;
        }
        .info-item a:hover {
            color: #BFDBFE;
        }
        .social-links {
            display: flex;
            gap: 1.5rem;
        }
        .social-links a svg {
            width: 2rem;
            height: 2rem;
            fill: #9CA3AF;
            transition: fill 0.2s ease-in-out;
        }
        .social-links a:hover svg {
            fill: #E5E7EB;
        }

        @media (max-width: 640px) { 
            #app-container { padding: 1rem; justify-content: flex-start; } 
            .stand { font-size: 1.8vw; } 
            .stand-tooltip { font-size: 2.2vw; padding: 0.4rem 0.8rem;} 
            #modal-prev { left: 5px; } 
            #modal-next { right: 5px; }
            .lantern-corner-container { width: 12rem; height: 12rem; }
            .lantern { transform: scale(0.7); }
            .event-info-container { margin-top: 1rem; padding: 1rem; }
            .info-item { font-size: 1rem; text-align: center; }
        }

        @keyframes float-sway {
            0%, 100% { transform: rotate(-2deg) translateY(0px); }
            50% { transform: rotate(2deg) translateY(-8px); }
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.9) rotate(0deg); }
            50% { opacity: 0.8; transform: scale(1) rotate(5deg); }
        }
        .lantern {
            position: absolute; 
            animation: float-sway 7s infinite ease-in-out;
            transform-origin: center center;
            will-change: transform; 
        }
        .star {
            position: absolute; 
            animation: twinkle linear infinite;
            will-change: opacity, transform;
        }
    </style>
</head>
<body>
    <svg style="position:absolute; width:0; height:0;">
        <defs>
            <filter id="lantern-glow">
                <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur" />
                <feMerge>
                    <feMergeNode in="blur" />
                    <feMergeNode in="SourceGraphic" />
                </feMerge>
            </filter>
        </defs>
    </svg>

    <div id="background-container" class="fixed inset-0 z-[-10] overflow-hidden bg-gray-900">
        <div id="star-container" class="absolute inset-0 pointer-events-none"></div>
        <div class="absolute top-0 left-0 right-0 h-64">
            <div class="lantern-corner-container absolute top-0 left-0 w-64 h-64 md:w-96 md:h-96">
                <div class="relative w-full h-full">
                    <div class="lantern top-[10%] left-[5%]" style="animation-delay: 0.5s;"><svg class="w-12 h-14 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                    <div class="lantern top-[25%] left-[30%]" style="animation-delay: 1.8s;"><svg class="w-16 h-20 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                    <div class="lantern top-[45%] left-[15%]" style="animation-delay: 1.2s;"><svg class="w-10 h-12 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                    <div class="lantern top-[50%] left-[40%]" style="animation-delay: 2.5s;"><svg class="w-14 h-16 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                    <div class="lantern top-[35%] left-[5%]" style="animation-delay: 3.1s;"><svg class="w-8 h-10 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                </div>
            </div>
            <div class="lantern-corner-container absolute top-0 right-0 w-64 h-64 md:w-96 md:h-96">
                <div class="relative w-full h-full">
                    <div class="lantern top-[15%] right-[10%]" style="animation-delay: 0s;"><svg class="w-20 h-24 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                    <div class="lantern top-[38%] right-[30%]" style="animation-delay: 0.8s;"><svg class="w-14 h-16 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                    <div class="lantern top-[55%] right-[15%]" style="animation-delay: 2.2s;"><svg class="w-12 h-14 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                    <div class="lantern top-[10%] right-[45%]" style="animation-delay: 1.5s;"><svg class="w-10 h-12 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                    <div class="lantern top-[60%] right-[40%]" style="animation-delay: 3.5s;"><svg class="w-8 h-10 text-red-600" viewBox="0 0 24 24" fill="currentColor" filter="url(#lantern-glow)"><path d="M16 6c0-2.21-1.79-4-4-4S8 3.79 8 6v1h8V6zM8 9v10c0 2.21 1.79 4 4 4s4-1.79 4-4V9H8z"/></svg></div>
                </div>
            </div>
        </div>
        <div class="absolute inset-0">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[80vw] h-[80vw] md:w-[50vw] md:h-[50vw] bg-gray-800/20 rounded-full blur-3xl"></div>
        </div>
        <div class="absolute bottom-0 left-0 right-0 h-48">
            <svg class="absolute bottom-0 left-0 right-0 w-full h-full text-gray-800/90" viewBox="0 0 800 100" preserveAspectRatio="none" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M800 100H0V56.8s28.1-28.1 78.6-28.1 63.5 21.1 120.9 21.1S291.9 32 344.4 32s63.5 35.8 114.9 35.8S540.9 2.1 600.4 2.1c59.5 0 82.1 40.6 121.9 40.6s77.7-25.5 77.7-25.5V100z" opacity="0.7"/>
                <path d="M800 100H0V71.9s22.2-22.2 62.1-22.2S130 71.9 180.5 71.9 253.9 32 306.4 32s63.5 35.8 114.9 35.8S502.9 20.9 562.4 20.9c59.5 0 96.4 46.5 136.2 46.5s101.4-36.2 101.4-36.2V100z"/>
            </svg>
        </div>
    </div>

    <div id="admin-controls" class="w-56">
        <h3 class="text-white font-bold text-center mb-3">Modo Admin</h3>
        <div class="space-y-3">
            <button id="position-mode-toggle" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg transition-all text-sm">Editar Posición</button>
            <button id="info-mode-toggle" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-3 rounded-lg transition-all text-sm">Editar Información</button>
        </div>
        <hr class="my-4 border-gray-600">
        <div id="show-hidden-container" class="mt-3 flex items-center hidden">
            <input type="checkbox" id="show-hidden-toggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
            <label for="show-hidden-toggle" class="ml-2 block text-sm text-gray-300">Mostrar Ocultos</label>
        </div>
        <div class="mt-3">
            <label class="block text-sm font-medium text-gray-300 mb-1">Tamaño Global (%)</label>
            <div class="flex items-center space-x-2">
                <input type="number" id="global-width" placeholder="Ancho" class="w-full bg-gray-700 text-white rounded p-1 text-sm" value="12">
                <input type="number" id="global-height" placeholder="Alto" class="w-full bg-gray-700 text-white rounded p-1 text-sm" value="8">
            </div>
            <button id="apply-global-size" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white py-1.5 rounded-lg text-sm">Aplicar</button>
        </div>
        <div class="mt-3">
            <button id="reset-rotations" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-1.5 rounded-lg text-sm">Restablecer Rotación</button>
        </div>
    </div>

    <div id="app-container">
        <div id="main-logo-container" class="logo-container"><img src="./sources/fuyu.png" alt="Logo del Evento"></div>
        <div id="map-card"><div id="map-container"></div></div>
        
        <div class="logo-container flex flex-col items-center">
            <h4 class="text-gray-400 text-sm tracking-widest uppercase mb-4">Organizan</h4>
            <div class="flex items-start justify-center gap-6 w-full">
                <div class="w-1/2 flex flex-col items-center text-center gap-2">
                    <img src="./sources/seinen.png" alt="Logo de Seinenbu" class="max-h-16">
                    <p class="text-xs text-gray-400">@seinenbu.enc</p>
                </div>
                <div class="w-1/2 flex flex-col items-center text-center gap-2">
                    <img src="./sources/aso.png" alt="Logo de la Asociación Japonesa" class="max-h-16">
                    <p class="text-xs text-gray-400">@asociacionjaponesa.enc</p>
                </div>
            </div>
        </div>
        
        <div class="event-info-container">
            <div class="info-item">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <span>9 de agosto - 19:00 hs</span>
            </div>
            <div class="info-item">
                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                <a href="https://g.co/kgs/GC4XHkQ" target="_blank" rel="noopener noreferrer">Polideportivo de la Asociación Japonesa de Encarnación</a>
            </div>
            <div class="social-links">
                <a href="https://www.instagram.com/seinenbu.enc" target="_blank" rel="noopener noreferrer" aria-label="Instagram de Seinenbu">
                    <svg viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg>
                </a>
                <a href="https://www.instagram.com/asociacionjaponesa.enc" target="_blank" rel="noopener noreferrer" aria-label="Instagram de la Asociación Japonesa">
                    <svg viewBox="0 0 24 24"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2A5.8,5.8 0 0,1 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8A5.8,5.8 0 0,1 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4A3.6,3.6 0 0,0 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg>
                </a>
            </div>
        </div>
    </div>

    <div id="info-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden z-50">
        <div class="relative w-full max-w-lg">
            <button id="modal-prev" class="modal-nav">&lt;</button>
            <div id="modal-content" class="bg-gray-900 border border-gray-700 rounded-2xl shadow-xl p-6 w-full transform scale-95 opacity-0 overflow-y-auto max-h-[90vh]"></div>
            <button id="modal-next" class="modal-nav">&gt;</button>
        </div>
    </div>

    <div id="lightbox" class="modal-backdrop fixed inset-0 hidden z-50">
        <button id="lightbox-close">&times;</button>
        <button id="lightbox-prev" class="lightbox-nav">&lt;</button>
        <img id="lightbox-image" src="" alt="Imagen ampliada">
        <button id="lightbox-next" class="lightbox-nav">&gt;</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, setDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "__API_KEY__",
            authDomain: "__AUTH_DOMAIN__",
            projectId: "__PROJECT_ID__",
            storageBucket: "__STORAGE_BUCKET__",
            messagingSenderId: "__MESSAGING_SENDER_ID__",
            appId: "__APP_ID__"
        };
        const ADMIN_UID = "__ADMIN_UID__";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const mapContainer = document.getElementById('map-container');
        const mapCard = document.getElementById('map-card');
        const adminControls = document.getElementById('admin-controls');
        const positionModeToggle = document.getElementById('position-mode-toggle');
        const infoModeToggle = document.getElementById('info-mode-toggle');
        const showHiddenContainer = document.getElementById('show-hidden-container');
        const showHiddenToggle = document.getElementById('show-hidden-toggle');
        const infoModal = document.getElementById('info-modal');
        const modalContent = document.getElementById('modal-content');
        const modalPrevBtn = document.getElementById('modal-prev');
        const modalNextBtn = document.getElementById('modal-next');
        const globalWidthInput = document.getElementById('global-width');
        const globalHeightInput = document.getElementById('global-height');
        const applyGlobalSizeBtn = document.getElementById('apply-global-size');
        const resetRotationsBtn = document.getElementById('reset-rotations');
        const lightbox = document.getElementById('lightbox');
        const lightboxImage = document.getElementById('lightbox-image');
        const lightboxPrev = document.getElementById('lightbox-prev');
        const lightboxNext = document.getElementById('lightbox-next');
        
        let isAdmin = false, isPositionEditMode = false, isInfoEditMode = false, showHidden = false;
        let standsData = new Map();
        let currentLightboxImages = [], currentLightboxIndex = 0;
        let longPressTimer;
        let sortedStands = [];
        let activeModalStandId = null; 

        async function updateFirestoreDoc(docId, data) {
            await setDoc(doc(db, "fuyumatsuri-stands", docId), data, { merge: true });
        }

        window.Login = async function() {
            if (isAdmin) return;
            const email = prompt("Email de administrador:");
            const password = prompt("Contraseña:");
            if (!email || !password) return;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert("Error al iniciar sesión: " + error.message);
            }
        }

        onAuthStateChanged(auth, (user) => {
            isAdmin = user && user.uid === ADMIN_UID;
            adminControls.style.display = isAdmin ? 'block' : 'none';
        });
        
        async function applyGlobalSize() {
            const width = parseFloat(globalWidthInput.value);
            const height = parseFloat(globalHeightInput.value);
            if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) return alert("Ingresa un ancho y alto válidos.");
            const batch = writeBatch(db);
            standsData.forEach(stand => {
                if(stand.status !== 'hidden') {
                    batch.update(doc(db, "fuyumatsuri-stands", stand.id), { width, height })
                }
            });
            await batch.commit();
        }

        async function resetAllRotations() {
            const batch = writeBatch(db);
            standsData.forEach(stand => {
                 if(stand.status !== 'hidden') {
                    batch.update(doc(db, "fuyumatsuri-stands", stand.id), { rotation: 0 })
                 }
            });
            await batch.commit();
        }
        
        function updateStandOnMap(standData) {
            let el = mapContainer.querySelector(`.stand[data-id='${standData.id}']`);
            if (!el) {
                el = document.createElement('div');
                el.dataset.id = standData.id;
                mapContainer.appendChild(el);
            }

            const statusClass = standData.status === 'occupied' ? 'occupied' : 'available';
            const hiddenClass = standData.status === 'hidden' ? 'hidden-visible' : '';
            el.className = `stand ${statusClass} ${hiddenClass} ${isPositionEditMode ? 'position-edit-mode' : ''}`;
            el.style.cssText = `top:${standData.top}%; left:${standData.left}%; width:${standData.width}%; height:${standData.height}%; transform:translate(-50%,-50%) rotate(${standData.rotation||0}deg)`;
            el.textContent = standData.displayId || standData.id;
            
            el.replaceWith(el.cloneNode(true));
            el = mapContainer.querySelector(`.stand[data-id='${standData.id}']`);

            const clickEnabled = !isPositionEditMode || (isPositionEditMode && isInfoEditMode);
            if (clickEnabled) {
                addStandListeners(el, standData);
            }
            if (isPositionEditMode) {
                makeEditable(el, standData);
            }

             const shouldBeVisible = !(standData.status === 'hidden' && !(isAdmin && (isPositionEditMode || isInfoEditMode) && showHidden));
             el.style.display = shouldBeVisible ? 'flex' : 'none';
        }

        function addStandListeners(el, stand) {
            let wasLongPress = false;
            el.addEventListener('click', (e) => {
                if (wasLongPress) { e.preventDefault(); return; }
                const standIndex = sortedStands.findIndex(s => s.id === stand.id);
                if (standIndex === -1) return;
                (isAdmin && isInfoEditMode) ? buildAdminModal(standIndex) : buildVisitorModal(standIndex);
            });

            if (stand.status === 'occupied' && stand.mainProduct) {
                let tooltip = el.querySelector('.stand-tooltip');
                if (!tooltip) {
                    tooltip = document.createElement('div');
                    tooltip.className = 'stand-tooltip';
                    el.appendChild(tooltip);
                }
                tooltip.textContent = stand.mainProduct;
                el.addEventListener('contextmenu', e => e.preventDefault());
                el.addEventListener('touchstart', (e) => {
                    wasLongPress = false;
                    longPressTimer = setTimeout(() => {
                        wasLongPress = true;
                        el.classList.add('show-tooltip');
                    }, 500);
                }, { passive: true });
                el.addEventListener('touchend', () => { clearTimeout(longPressTimer); setTimeout(() => el.classList.remove('show-tooltip'), 200); });
                el.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            }
        }

        function removeStandFromMap(standId) {
            const el = mapContainer.querySelector(`.stand[data-id='${standId}']`);
            if (el) el.remove();
        }
        
        function makeEditable(element, dataObject) {
            element.style.pointerEvents = 'auto'; 
            element.onmousedown = e => {
                if (e.target.classList.contains('handle')) return;
                e.preventDefault();
                const mapRect = mapContainer.getBoundingClientRect();
                const onMouseMove = e_move => {
                    element.style.left = `${(e_move.clientX - mapRect.left) / mapRect.width * 100}%`;
                    element.style.top = `${(e_move.clientY - mapRect.top) / mapRect.height * 100}%`;
                };
                const onMouseUp = e_up => {
                    document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp);
                    const newLeft = (e_up.clientX - mapRect.left) / mapRect.width * 100;
                    const newTop = (e_up.clientY - mapRect.top) / mapRect.height * 100;
                    updateFirestoreDoc(dataObject.id, { top: newTop, left: newLeft });
                };
                document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
            };
            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'handle resize-handle';
            element.appendChild(resizeHandle);
            resizeHandle.onmousedown = e_resize => {
                e_resize.stopPropagation();
                const mapRect = mapContainer.getBoundingClientRect();
                const startX = e_resize.clientX, startY = e_resize.clientY, startWidth = element.offsetWidth, startHeight = element.offsetHeight;
                const onMouseMove = e_move => {
                    element.style.width = `${(startWidth + e_move.clientX - startX) / mapRect.width * 100}%`;
                    element.style.height = `${(startHeight + e_move.clientY - startY) / mapRect.height * 100}%`;
                };
                const onMouseUp = e_up => {
                    document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp);
                    const newWidth = (startWidth + e_up.clientX - startX) / mapRect.width * 100;
                    const newHeight = (startHeight + e_up.clientY - startY) / mapRect.height * 100;
                    updateFirestoreDoc(dataObject.id, { width: newWidth, height: newHeight });
                };
                document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
            };
            const rotateHandle = document.createElement('div');
            rotateHandle.className = 'handle rotate-handle';
            element.appendChild(rotateHandle);
            rotateHandle.onmousedown = e_rotate => {
                e_rotate.stopPropagation();
                const rect = element.getBoundingClientRect(), centerX = rect.left + rect.width / 2, centerY = rect.top + rect.height / 2;
                const onMouseMove = e_move => {
                    const angle = Math.atan2(e_move.clientY - centerY, e_move.clientX - centerX) * (180 / Math.PI) + 90;
                    element.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
                };
                const onMouseUp = e_up => {
                    document.removeEventListener('mousemove', onMouseMove); document.removeEventListener('mouseup', onMouseUp);
                    const angle = Math.atan2(e_up.clientY - centerY, e_up.clientX - centerX) * (180 / Math.PI) + 90;
                    updateFirestoreDoc(dataObject.id, { rotation: angle });
                };
                document.addEventListener('mousemove', onMouseMove); document.addEventListener('mouseup', onMouseUp);
            };
        }
        
        function showModal(standId) { 
            activeModalStandId = standId;
            infoModal.classList.remove('hidden'); 
            setTimeout(() => modalContent.classList.remove('scale-95', 'opacity-0'), 10); 
        }
        function hideModal() { 
            activeModalStandId = null;
            modalContent.classList.add('scale-95', 'opacity-0'); 
            setTimeout(() => infoModal.classList.add('hidden'), 300); 
        }

        function buildVisitorModal(standIndex) {
            const stand = sortedStands[standIndex];
            if (!stand) return;
            const galleryContent = stand.gallery && stand.gallery.length > 0 ? `<div class="mt-6"><h4 class="text-lg font-semibold mb-2">Galería:</h4><div class="gallery-grid gallery-count-${stand.gallery.length}">${stand.gallery.map((img, i) => `<div class="gallery-item"><img src="${img}" data-index="${i}" alt="Imagen de galería ${i + 1}"></div>`).join('')}</div></div>` : '';
            const productSubtitle = stand.mainProduct ? `<p class="text-lg text-yellow-400 -mt-2 mb-3">${stand.mainProduct}</p>` : '';
            const availableTitle = `<h3 class="text-2xl font-bold text-green-400">Stand Disponible</h3>`;
            const infoSection = `<div class="min-h-[100px]"><h3 class="text-2xl font-bold text-blue-400">${stand.owner||"Expositor"}</h3>${productSubtitle}<p class="text-gray-300 mt-2 whitespace-pre-wrap">${stand.info||"No hay información."}</p></div>`;
            modalContent.innerHTML = `<div class="flex justify-between items-start"><h2 class="text-3xl font-bold text-white mb-4">Stand ${stand.displayId||stand.id}</h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">×</button></div>${stand.status==='available'?`<div class="bg-gray-800 p-4 rounded-lg min-h-[150px]">${availableTitle}<p class="text-gray-300 mt-2">Asegura tu lugar en Fuyumatsuri. Completa nuestro formulario de inscripción para reservar este espacio.</p><a href="https://docs.google.com/forms/d/e/1FAIpQLSc-2Ntyup0p6-3NKENTnGaYR9nat--68nfWUEZvzFleykwXkg/viewform?usp=header" class="mt-4 inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-all">¡Quiero reservar!</a></div>`:`${infoSection}${galleryContent}`}`;
            modalContent.querySelector('#close-modal-btn').onclick = hideModal;
            modalContent.querySelectorAll('.gallery-item img').forEach(img => img.onclick = () => openLightbox(stand.gallery, parseInt(img.dataset.index)));
            modalPrevBtn.onclick = () => { buildVisitorModal((standIndex - 1 + sortedStands.length) % sortedStands.length); };
            modalNextBtn.onclick = () => { buildVisitorModal((standIndex + 1) % sortedStands.length); };
            showModal(stand.id);
        }

        function buildAdminModal(standIndex) {
            const currentId = sortedStands[standIndex].id;
            const stand = standsData.get(currentId);
            if (!stand) return;
            const galleryHTML = stand.gallery ? stand.gallery.map((img, index) => `<div class="relative"><img src="${img}" class="w-24 h-24 object-cover rounded-md"><button data-index="${index}" class="delete-img-btn">×</button></div>`).join('') : '';
            modalContent.innerHTML = `<div class="flex justify-between items-start"><h2 class="text-3xl font-bold text-white mb-4">Editar Stand ${stand.displayId||stand.id}</h2><button id="close-modal-btn" class="text-gray-400 hover:text-white text-3xl">×</button></div><div class="space-y-4"><div><label class="block text-sm font-medium text-gray-400 mb-1">Estado</label><select id="stand-status" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2"><option value="available" ${stand.status==='available'?'selected':''}>Disponible</option><option value="occupied" ${stand.status==='occupied'?'selected':''}>Ocupado</option><option value="hidden" ${stand.status==='hidden'?'selected':''}>Oculto</option></select></div><div><label for="stand-owner" class="block text-sm font-medium text-gray-400 mb-1">Titular</label><input type="text" id="stand-owner" value="${stand.owner||''}" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2"></div><div><label for="stand-product" class="block text-sm font-medium text-gray-400 mb-1">Producto Principal (para tooltip)</label><input type="text" id="stand-product" value="${stand.mainProduct||''}" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2"></div><div><label for="stand-info" class="block text-sm font-medium text-gray-400 mb-1">Información Adicional</label><textarea id="stand-info" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2">${stand.info||''}</textarea></div><div><label class="block text-sm font-medium text-gray-400 mb-1">Galería</label><div id="gallery-preview" class="flex flex-wrap gap-4 mb-2 p-2 bg-gray-800 rounded-lg min-h-[110px]">${galleryHTML}</div><label for="add-image" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">+ Agregar Imagen</label><input type="file" id="add-image" class="hidden" accept="image/*"></div><button id="save-stand-changes" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition-all">Guardar Cambios</button></div>`;
            
            document.getElementById('save-stand-changes').onclick = () => {
                const updatedData = { status: document.getElementById('stand-status').value, owner: document.getElementById('stand-owner').value, mainProduct: document.getElementById('stand-product').value, info: document.getElementById('stand-info').value, };
                updateFirestoreDoc(stand.id, updatedData).then(hideModal);
            };
            document.getElementById('add-image').onchange = e => {
                if (e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = re => { updateFirestoreDoc(stand.id, { gallery: [...(stand.gallery || []), re.target.result] }); };
                    reader.readAsDataURL(e.target.files[0]);
                }
            };
            modalContent.querySelectorAll('.delete-img-btn').forEach(btn => {
                btn.onclick = () => { updateFirestoreDoc(stand.id, { gallery: stand.gallery.filter((_, i) => i !== parseInt(btn.dataset.index)) }); };
            });
            modalContent.querySelector('#close-modal-btn').onclick = hideModal;
            modalPrevBtn.onclick = () => { buildAdminModal((standIndex - 1 + sortedStands.length) % sortedStands.length); };
            modalNextBtn.onclick = () => { buildAdminModal((standIndex + 1) % sortedStands.length); };
            showModal(stand.id);
        }

        function openLightbox(images, index) { currentLightboxImages = images; currentLightboxIndex = index; lightbox.classList.remove('hidden'); updateLightboxImage(); }
        function updateLightboxImage() { lightboxImage.src = currentLightboxImages[currentLightboxIndex]; }
        function changeLightboxImage(direction) { currentLightboxIndex = (currentLightboxIndex + direction + currentLightboxImages.length) % currentLightboxImages.length; updateLightboxImage(); }
        function togglePositionMode() {
            isPositionEditMode = !isPositionEditMode;
            positionModeToggle.classList.toggle('bg-blue-600', isPositionEditMode); positionModeToggle.classList.toggle('bg-gray-600', !isPositionEditMode);
            showHiddenContainer.classList.toggle('hidden', !isPositionEditMode && !isInfoEditMode);
            if (!isPositionEditMode) { showHiddenToggle.checked = false; showHidden = false; }
            mapCard.classList.toggle('position-edit-mode', isPositionEditMode);
            Array.from(standsData.values()).forEach(updateStandOnMap);
        }
        function toggleInfoMode() {
            isInfoEditMode = !isInfoEditMode;
            infoModeToggle.classList.toggle('bg-blue-600', isInfoEditMode); infoModeToggle.classList.toggle('bg-gray-600', !isInfoEditMode);
            showHiddenContainer.classList.toggle('hidden', !isPositionEditMode && !isInfoEditMode);
            if (!isInfoEditMode) { showHiddenToggle.checked = false; showHidden = false; }
            Array.from(standsData.values()).forEach(updateStandOnMap);
        }

        async function main() {
            try {
                onSnapshot(collection(db, "fuyumatsuri-stands"), (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const standData = { id: change.doc.id, ...change.doc.data() };
                        if (change.type === "added" || change.type === "modified") {
                            standsData.set(standData.id, standData);
                            updateStandOnMap(standData);
                        }
                        if (change.type === "removed") {
                            standsData.delete(standData.id);
                            removeStandFromMap(standData.id);
                        }
                    });
                    const standsToRender = (isAdmin && (isPositionEditMode || isInfoEditMode) && showHidden) ? Array.from(standsData.values()) : Array.from(standsData.values()).filter(s => s.status !== 'hidden');
                    sortedStands = standsToRender.sort((a,b) => parseInt(a.id) - parseInt(b.id));

                    if (activeModalStandId && !infoModal.classList.contains('hidden')) {
                        const currentStandIndex = sortedStands.findIndex(s => s.id === activeModalStandId);
                        if (currentStandIndex !== -1) {
                            if (document.getElementById('save-stand-changes')) { buildAdminModal(currentStandIndex); }
                             else { buildVisitorModal(currentStandIndex); }
                        } else { hideModal(); }
                    }
                });
            } catch (error) { console.error("Error en la inicialización:", error); }
        }

        positionModeToggle.addEventListener('click', togglePositionMode);
        infoModeToggle.addEventListener('click', toggleInfoMode);
        showHiddenToggle.addEventListener('change', () => { showHidden = showHiddenToggle.checked; Array.from(standsData.values()).forEach(updateStandOnMap); });
        applyGlobalSizeBtn.addEventListener('click', applyGlobalSize);
        resetRotationsBtn.addEventListener('click', resetAllRotations);
        infoModal.addEventListener('click', (e) => { if (e.target === infoModal) hideModal(); });
        document.getElementById('lightbox-close').onclick = () => lightbox.classList.add('hidden');
        lightboxPrev.onclick = () => changeLightboxImage(-1);
        lightboxNext.onclick = () => changeLightboxImage(1);
        lightbox.addEventListener('click', (e) => { if (e.target === lightbox) { lightbox.classList.add('hidden'); } });
        main();
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const starContainer = document.getElementById('star-container');
            const isMobile = window.innerWidth < 768;

            const starColors = ['#FFFFFF', '#FFFACD', '#FFDFD3'];
            const numberOfStars = isMobile ? 25 : 50; 
            for (let i = 0; i < numberOfStars; i++) {
                const star = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                const size = Math.random() * 4 + 1.5; 
                
               
                const hMargin = 15; const vMargin = 15;
                const left = Math.random() * (100 - hMargin * 2) + hMargin;
                const top = Math.random() * (100 - vMargin * 2) + vMargin;
                
                const duration = Math.random() * 5 + 4;
                const delay = Math.random() * 9;
                
                star.setAttribute('class', 'star');
                star.setAttribute('viewBox', '0 0 20 20');
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.top = `${top}vh`;
                star.style.left = `${left}vw`;
                star.style.animationDuration = `${duration}s`;
                star.style.animationDelay = `${delay}s`;

                const starPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                starPath.setAttribute('d', 'M10 0 L12.24 7.76 L20 10 L12.24 12.24 L10 20 L7.76 12.24 L0 10 L7.76 7.76 Z');
                const color = starColors[i % starColors.length];
                starPath.setAttribute('fill', color);
                starPath.style.filter = `drop-shadow(0 0 6px ${color})`;
                
                star.appendChild(starPath);
                starContainer.appendChild(star);
            }
        });
    </script>
</body>
</html>
